<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SMS â€“ Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial;margin:0;display:grid;place-items:center;height:100vh;background:#f7f7fb}
    .card{background:#fff; padding:24px; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.08); width:min(420px,90vw)}
    h2{margin:0 0 12px}
    input,button{width:100%;padding:10px;margin:6px 0;border:1px solid #ddd;border-radius:8px}
    button{background:#4f46e5;color:#fff;border:none;cursor:pointer}
    .row{display:flex;gap:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Simple Messaging System</h2>
    <input id="display_name" placeholder="Username">
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <div class="row">
      <button onclick="register()">Register</button>
      <button onclick="login()">Login</button>
    </div>
    <div id="msg" style="color:#dc2626;margin-top:8px;font-weight:500"></div>
  </div>

  <script>
    async function register(){
        if (!validateForm()) return;
        await post('/api/register', {
        email: g('email').value,
        password: g('password').value,
        display_name: g('display_name').value          // NEW
        });
        await setupGeneralChat();
        go();
    }
    async function login(){
        if (!validateForm()) return;
        await post('/api/login', {
        email: g('email').value,
        password: g('password').value
        });
        await setupGeneralChat();
        go();
    }
    
    function validateForm(){
        const displayName = g('display_name').value.trim();
        const email = g('email').value.trim();
        const password = g('password').value.trim();
        
        if (!displayName) {
            g('msg').textContent = 'Please enter a username';
            return false;
        }
        if (!email) {
            g('msg').textContent = 'Please enter an email';
            return false;
        }
        if (!password) {
            g('msg').textContent = 'Please enter a password';
            return false;
        }
        if (!isValidEmail(email)) {
            g('msg').textContent = 'Please enter a valid email address';
            return false;
        }
        return true;
    }
    
    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
    async function setupGeneralChat(){
        try {
            // Try to create General Chat room (will fail if it already exists, which is fine)
            await post('/api/room/create', {
                room_id: 'general',
                name: 'General Chat'
            });
        } catch(e) {
            // Room might already exist, that's okay
        }
        
        try {
            // Join the General Chat room
            await post('/api/room/join', {
                room_id: 'general'
            });
        } catch(e) {
            // User might already be in the room, that's okay
        }
    }
    
    function vals(){ return {email: g('email').value, password: g('password').value}; }
    function g(id){ return document.getElementById(id); }
    function go(){ window.location.href = '/app'; }
    async function post(url, body){
      const r = await fetch(url, {method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify(body)});
      if(!r.ok){ 
        try {
          const errorData = await r.json();
          g('msg').textContent = errorData.detail || 'An error occurred';
        } catch {
          g('msg').textContent = 'An error occurred';
        }
        throw new Error('Request failed');
      }
      return await r.json();
    }
  </script>
</body>
</html>
